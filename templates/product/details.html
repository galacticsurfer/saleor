{% extends "base.html" %}

{% load bootstrap_field from bootstrap3 %}
{% load i18n %}
{% load gross from prices_i18n %}
{% load markdown from markdown %}
{% load price_range from price_ranges %}
{% load static from staticfiles %}
{% load get_thumbnail from product_images %}

{% load staticfiles %}
{% load product_first_image from product_images %}
{% load product_availability_schema from jsonld %}

{% block title %}{{ product }} â€” {{ block.super }}{% endblock %}

{% block breadcrumb %}
  <ul class="breadcrumbs list-unstyled">
    <li><a href="/">
        {% trans "Home" context "Product details breadcrumbs" %}
    </a></li>
    {% with product.get_first_category as category %}
      {% if category %}
        <li><a href="{{ category.get_absolute_url }}">{{ category }}</a></li>
      {% endif %}
    {% endwith %}
    <li><a href="{{ product.get_absolute_url }}">{{ product }}</a></li>
  </ul>
{% endblock breadcrumb %}

{% block content %}
  {% if not is_visible %}
    <div class="alert alert-warning" role="alert">
      {% blocktrans trimmed with date=product.available_on|date context "Product details text" %}
          <strong>Warning!</strong>
          You are previewing a product that will become visible on <strong>{{ date }}</strong>.
      {% endblocktrans %}
    </div>
  {% endif %}
  <div class="row product">
    <div id="product-schema-component">
      <script type="application/ld+json">{{ json_ld_product_data|safe }}</script>
    </div>
    <div class="col-md-6 col-12 product__gallery">
      {% with images=product_images %}
        {% if images %}
          <div id="carousel-example-generic" class="carousel slide">
            <ol class="carousel-indicators hidden-sm-down">
              {% for image in images %}
                {% if images|length > 1 %}
                  <li data-target="#carousel-example-generic" data-slide-to="{{ forloop.counter0 }}">
                    <img src="{% get_thumbnail image.image method="crop" size="60x60" %}" alt="">
                  </li>
                {% endif %}
              {% endfor %}
            </ol>
            <div class="carousel-inner" role="listbox">
              {% for image in images %}
                <div class="carousel-item{% if forloop.first %} active{% endif %}">
                  <img class="d-block img-fluid" src="{% get_thumbnail image.image method="crop" size="750x750" %}" alt="">
                </div>
              {% endfor %}
            </div>
            {% if images|length > 1 %}
              <a class="carousel-control-prev" href="#carousel-example-generic" role="button" data-slide="prev">
                <img class="icon-next" src="{% static "images/gallery-arrow.svg" %}">
              </a>
              <a class="carousel-control-next" href="#carousel-example-generic" role="button" data-slide="next">
                <img class="icon-next" src="{% static "images/gallery-arrow.svg" %}">
              </a>
            {% endif %}
          </div>
        {% else %}
          <img src="{% static 'images/product-image-placeholder.png' %}" alt="" class="img-fluid">
        {% endif %}
      {% endwith %}
    </div>
    <div class="col-md-6 col-12 product__info">
      <h1 class="product__info__name">
        {{ product }}
      </h1>
      {% if user.is_staff %}
        <p><a href="{% url "dashboard:product-update" pk=product.pk %}">
            {% trans "Edit in dashboard" context "Product details link text" %}
        </a></p>
      {% endif %}
      {% if availability.available %}
        {% if show_variant_picker %}
          <div id="variant-price-component"></div>
        {% else %}
          <h2 class="product__info__price">
            <span>{% price_range availability.price_range %}</span>
            {% if availability.discount %}
              <small class="product__info__price__undiscounted">{% gross availability.price_range_undiscounted.min_price html=True %}</small>
            {% endif %}
            {% if availability.price_range_local_currency %}
              <br>
              <small class="text-info">
                &asymp;
                {% gross availability.price_range_local_currency.min_price html=True %}
              </small>
            {% endif %}
          </h2>
        {% endif %}
      {% endif %}
      {% if is_visible and product.is_in_stock %}
        {% block orderform %}
          {% if show_variant_picker %}
            {% csrf_token %}
            <div id="variant-picker" data-variant-picker-data="{{ variant_picker_data }}" data-action="{% url 'product:add-to-cart' product_id=product.pk slug=product.get_slug %}"></div>
          {% else %}
            <form id="product-form" role="form" class="product-form form-vertical" method="post"
                  action="{% url 'product:add-to-cart' product_id=product.pk slug=product.get_slug %}" novalidate>
              {% csrf_token %}
              {% bootstrap_field form.variant %}
              <div class="product__info__quantity">
                {% bootstrap_field form.quantity %}
              </div>

              <div class="form-group product__info__button">
                <button class="btn primary">
                  {% trans "Add to cart" context "Product details primary action" %}
                </button>
              </div>
            </form>
          {% endif %}
        {% endblock %}
        <div class="product__info__form-error">
          <small class="text-danger"></small>
        </div>

      {% else %}
        <p class="alert alert-warning">
            {% trans "This product is currently <strong>unavailable</strong>." context "Product details text" %}
        </p>
      {% endif %}
      <div class="product__info__description">
        <h3>{% trans "Description" context "Product details title" %}</h3>
        <hr>
        {{ product.description|markdown }}
      </div>
      <hr>
      <table>
        {% for attribute, value in product_attributes.items %}
          <tr>
            <td>{{ attribute }}:</td>
            <td><strong>{{ value }}</strong></td>
          </tr>
        {% endfor %}
      </table>
    </div>
  </div>

<br/>

{% if recommended_products %}
  <br/>
  <hr>
  <h2>Frequently bought together</h2>
  <br/>

  <div class="row">
  {% for px,avx in recommended_products %}
      <div class="col-6 col-lg-3 product-list">
          <script type="application/ld+json">
            {% autoescape off %}{% product_availability_schema product %}{% endautoescape %}
          </script>
          <a href="{{ px.get_absolute_url }}">
              <div class="text-center">
                  <div>
                      <img class="img-responsive" src="{% product_first_image px method="crop" size="400x400" %}" alt="">
                      <span class="product-list-item-name" title="{{ px }}">{{ px }}</span>
                  </div>

                  <div class="panel-footer">
                      {% if avx.available %}
                          {% price_range avx.price_range %}
                          {% if avx.discount %}
                              {% if avx.price_range_undiscounted.min_price != avx.price_range.min_price %}
                                  <div class="product-list__sale"><img src="{% static "images/sale_bg.svg" %}">
                                      <span>
                                          {% comment %}Translators: Layout may break if character length is different than four.{% endcomment %}
                                          {% trans "Sale" context "Sale (discount) label for item in product list" %}
                                    </span>
                                  </div>
                              {% endif %}
                          {% endif %}
                      {% else %}
                          &nbsp;
                      {% endif %}
                  </div>
              </div>
          </a>
      </div>
  {% endfor %}
  </div>
  <hr>
{% endif %}
{% endblock content %}
